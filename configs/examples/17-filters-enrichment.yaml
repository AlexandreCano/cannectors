# Example: Enrichment Filter Module
#
# This example demonstrates the enrichment filter module, which fetches
# additional data from external APIs and merges it into records.
#
# Features demonstrated:
# - Dynamic enrichment with HTTP requests
# - Key extraction from record fields
# - Configurable caching to reduce API calls
# - Multiple parameter types (query, path, header)
# - Merge strategies (merge, replace, append)
# - Error handling modes

connector:
  name: orders-with-customer-enrichment
  version: 1.0.0
  description: Fetches orders and enriches them with customer data from a CRM API

  input:
    type: httpPolling
    endpoint: https://api.orders.example.com/orders
    schedule: "*/5 * * * *"  # Every 5 minutes
    dataField: orders
    authentication:
      type: bearer
      credentials:
        token: ${ORDERS_API_TOKEN}

  filters:
    # Enrichment filter: Fetch customer details for each order
    - type: http_call
      name: customer-enrichment
      description: Enriches orders with customer information from CRM

      # The endpoint to fetch enrichment data from
      # {id} is a placeholder that will be replaced with the key value
      endpoint: https://api.crm.example.com/customers/{id}

      # Key configuration: how to extract the key and use it in the request
      key:
        # Extract the key from this field in the record (supports dot notation)
        field: customerId
        # How to include the key in the request: query, path, or header
        paramType: path
        # The parameter name to use (matches {id} placeholder in endpoint)
        paramName: id

      # Authentication for the enrichment API
      authentication:
        type: api-key
        credentials:
          key: ${CRM_API_KEY}
          headerName: X-API-Key
          location: header

      # Cache configuration to reduce redundant API calls
      # Multiple orders with the same customerId will only trigger one API call
      cache:
        maxSize: 1000      # Maximum number of cached entries
        defaultTTL: 300    # Cache entries expire after 5 minutes (300 seconds)
        # key: "$.customerId"  # Optional: Custom cache key (JSON path or static string)
                                # If not specified, uses: endpoint + "::" + keyValue

      # Merge strategy: how to combine enrichment data with the record
      # - merge: Deep merge (default) - adds/updates fields recursively
      # - replace: Overwrites matching fields
      # - append: Adds enrichment data under "_enrichment" key
      mergeStrategy: merge

      # If the API returns a wrapper object, extract data from this field
      dataField: data

      # Error handling when enrichment fails
      # - fail: Stop processing (default)
      # - skip: Drop the record and continue
      # - log: Log error and continue with original record
      onError: log

      # Request timeout in milliseconds
      timeoutMs: 5000

      # Custom headers for the enrichment request
      headers:
        Accept: application/json
        X-Request-Source: canectors

    # Alternative: Query parameter example
    # - type: http_call
    #   name: product-enrichment
    #   endpoint: https://api.products.example.com/search
    #   key:
    #     field: productSku
    #     paramType: query    # Adds ?sku=VALUE to the URL
    #     paramName: sku
    #   cache:
    #     maxSize: 500
    #     defaultTTL: 600    # 10 minutes

    # Alternative: Header parameter example
    # - type: http_call
    #   name: tenant-context
    #   endpoint: https://api.tenant.example.com/context
    #   key:
    #     field: tenantId
    #     paramType: header   # Adds X-Tenant-ID: VALUE header
    #     paramName: X-Tenant-ID
    #   onError: skip

    # Mapping filter to structure the final output
    - type: mapping
      name: final-mapping
      mappings:
        - source: orderId
          target: id
        - source: customerId
          target: customer.id
        # These fields come from the enrichment
        - source: name
          target: customer.name
          onMissing: setNull
        - source: email
          target: customer.email
          onMissing: setNull
        - source: items
          target: orderItems
        - source: totalAmount
          target: total

  output:
    type: httpRequest
    endpoint: https://api.warehouse.example.com/orders
    method: POST
    authentication:
      type: bearer
      credentials:
        token: ${WAREHOUSE_API_TOKEN}

# Example record flow:
#
# Input record (from orders API):
# {
#   "orderId": "ORD-123",
#   "customerId": "CUST-456",
#   "items": [...],
#   "totalAmount": 99.99
# }
#
# After enrichment (customer data merged):
# {
#   "orderId": "ORD-123",
#   "customerId": "CUST-456",
#   "items": [...],
#   "totalAmount": 99.99,
#   "name": "John Doe",           # From CRM API
#   "email": "john@example.com",  # From CRM API
#   "phone": "+1-555-1234"        # From CRM API
# }
#
# After mapping (final structure):
# {
#   "id": "ORD-123",
#   "customer": {
#     "id": "CUST-456",
#     "name": "John Doe",
#     "email": "john@example.com"
#   },
#   "orderItems": [...],
#   "total": 99.99
# }
