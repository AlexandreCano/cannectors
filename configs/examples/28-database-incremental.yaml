# Example: Database Input with lastRunTimestamp
# Demonstrates using {{lastRunTimestamp}} for incremental queries

schemaVersion: "1.1.0"

connector:
  name: database-incremental-example
  version: "1.0.0"
  description: "Incrementally sync orders from database using lastRunTimestamp"

  input:
    type: database
    connectionStringRef: "${DATABASE_URL}"

    # Query with {{lastRunTimestamp}} placeholder
    # On first run: uses epoch time (1970-01-01) to get all records
    # On subsequent runs: uses last successful execution timestamp
    query: |
      SELECT id, customer_id, total_amount, status, updated_at
      FROM orders
      WHERE updated_at > {{lastRunTimestamp}}
      ORDER BY updated_at ASC
      LIMIT 1000

    # Enable incremental mode to persist lastRunTimestamp between runs
    incremental:
      enabled: true
      timestampField: "updated_at"  # Field to track for next run

    timeoutMs: 60000
    schedule: "*/1 * * * *"  # Every minute

  filters:
    - type: mapping
      mappings:
        - source: "id"
          target: "order_id"
        - source: "customer_id"
          target: "customer_reference"
        - source: "total_amount"
          target: "amount"
        - source: "status"
          target: "order_status"
  output:
    type: httpRequest
    config:
      endpoint: "https://api.example.com/orders/sync"
      method: POST
