# Example: SQL Call Filter for Data Enrichment
# Demonstrates enriching records with data from a database

schemaVersion: "1.1.0"

connector:
  name: sql-enrichment-example
  version: "1.0.0"
  description: "Enrich orders with customer details from database"

  input:
    type: httpPolling
    endpoint: "https://api.source.com/orders"
    method: GET
    schedule: "*/5 * * * *"

  filters:
    # Enrich with customer data from database
    - type: sql_call
      connectionStringRef: "${DATABASE_URL}"

      # Query with templating - {{record.field}} replaced with record values
      query: |
        SELECT name, email, tier, credit_limit
        FROM customers
        WHERE customer_id = {{record.customer_id}}

      # How to merge results with input record
      mergeStrategy: merge  # merge, replace, append

      # Optional: extract specific field from result
      # dataField: "tier"

      # Optional: store result under specific key (for append strategy)
      # resultKey: "customer"

      # Cache to avoid repeated queries for same customer
      cache:
        enabled: true
        maxSize: 1000
        defaultTTL: 300  # 5 minutes
        key: "{{record.customer_id}}"  # Cache key template

      # Error handling
      onError: skip  # fail, skip, log

      timeoutMs: 5000

    # Multiple queries example
    - type: sql_call
      connectionStringRef: "${DATABASE_URL}"

      # Execute multiple queries sequentially
      queries:
        - "SELECT discount_percent FROM promotions WHERE code = {{record.promo_code}}"
        - "SELECT tax_rate FROM tax_rates WHERE region = {{record.shipping_region}}"

      mergeStrategy: merge
      cache:
        enabled: true
        maxSize: 500
        defaultTTL: 600

  output:
    type: httpRequest
    config:
      endpoint: "https://api.destination.com/enriched-orders"
      method: POST
